<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Received | RBMI Inventory System</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #cce5ff, #e8f4ff);
      font-family: "Poppins", sans-serif;
    }

    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #007bff, #00c6ff);
      color: white;
      padding-top: 20px;
      position: fixed;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0,0,0,0.15);
    }

    .sidebar .brand {
      text-align: center;
      margin-bottom: 25px;
    }

    .sidebar .brand img {
      height: 55px;
      border-radius: 8px;
      background: #fff;
      padding: 5px 8px;
    }

    .sidebar .nav-link {
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 5px 12px;
      transition: 0.2s;
    }

    .nav-link:hover,
    .nav-link.active {
      background: rgba(255,255,255,0.2);
      transform: translateX(4px);
    }

    .main-content {
      margin-left: 260px;
      padding: 20px;
    }

    .topbar {
      background: #ffffff;
      padding: 10px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .section-card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 3px 12px rgba(0,114,255,0.12);
      margin-bottom: 25px;
    }

    .table th {
      background: #007bff;
      color: white;
      text-align: center;
    }

    .table td {
      text-align: center;
    }

    .sidebar .brand h5 {
  font-size: 16px;
  background: rgba(255,255,255,0.15);
  padding: 5px 10px;
  border-radius: 8px;
  display: inline-block;
  color: white;
}
.table th {
  background: #007bff;
  color: white;
  text-align: center;
}



    /* Suggestions dropdown styling */
    #suggestions {
      position: absolute;
      width: 100%;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      max-height: 180px;
      overflow-y: auto;
      display: none;
      z-index: 2000;
    }
    #suggestions button {
      text-align: left;
    }
  </style>

</head>
<body>

  <!-- Sidebar -->
<!-- Sidebar -->
<div class="sidebar">
  <div class="brand">
    <img src="{{ url_for('static', filename='images/rbmi_logo.png') }}">
    <h5>RBMI Inventory<br>Management System</h5>
  </div>

  <hr style="border-color: rgba(255,255,255,0.3)">

  <a class="nav-link" href="{{ url_for('add_item_master') }}">
    <i class="bi bi-speedometer2"></i> Add Item
  </a>

  <a class="nav-link active" href="{{ url_for('order_received') }}">
    <i class="bi bi-cart-check"></i> Order Received
  </a>
  <a class="nav-link" href="{{ url_for('manager_dashboard') }}">
    <i class="bi bi-box-seam"></i> Stock Dashboard
  </a>
  <a class="nav-link" href="{{ url_for('mess_dashboard') }}"><i class="bi bi-egg-fried"></i> Mess Dashboard</a>
  <a class="nav-link" href="{{ url_for('canteen_dashboard') }}"><i class="bi bi-shop"></i> Canteen Dashboard</a>
<a class="nav-link " href="{{ url_for('usage_report') }}"><i class="bi bi-file-earmark-text"></i> Usage Report</a>
<a class="nav-link" href="{{ url_for('change_password') }}"><i class="bi bi-key"></i> Change Password</a>
<a class="nav-link text-danger" href="{{ url_for('logout') }}">
      <i class="bi bi-box-arrow-right"></i> Logout
    </a>
</div>



  <!-- Main -->
  <div class="main-content">

    <div class="topbar d-flex justify-content-between">
      <h5 class="fw-bold text-primary">Order / Purchase Received</h5>
    </div>

    <!-- FLASH -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}

        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="section-card">

  <h4 class="text-primary fw-bold mb-3">Add New Order</h4>

  <form method="POST">
    <table class="table table-bordered text-center align-middle">

      <!-- HEADERS ROW -->
      <tr>
  <th>Vendor</th>
  <th>Item</th>
  <th>Total Qty</th>
  <th>Unit</th>
  <th>Price</th>
  <th>Mess Qty</th>
  <th>Canteen Qty</th>
  <th>Action</th>
</tr>


      <!-- INPUTS ROW -->
      <tr>

        <td>
          <input type="text" name="vendor_name" class="form-control" required>
        </td>

        <!-- SEARCHABLE ITEM -->
        <td style="position:relative;">
          <input type="text" id="itemInput" class="form-control" placeholder="Search item..." autocomplete="off" required>

          <input type="hidden" name="item_id" id="item_id">
          <div id="suggestions" class="list-group"></div>
        </td>
<td>
          <input type="number" min="0" step="0.01" name="total_qty" class="form-control" required>
        </td>
        <td>
          <input type="text" name="unit" id="unitBox" class="form-control" readonly>
        </td>
<td>
          <input type="number" min="0" step="0.01" name="price" class="form-control" required>
        </td>
        <td>
          <input type="number" min="0" step="0.01" name="mess_qty" class="form-control" required>
        </td>

        <td>
          <input type="number" min="0" step="0.01" name="canteen_qty" class="form-control" required>
        </td>

        <td>
          <button class="btn btn-primary w-100">Save</button>
        </td>

      </tr>
    </table>
  </form>
</div>

    <!-- SEARCH -->
    <div class="section-card">
      <h4 class="text-primary fw-bold mb-3">Order Recieved History</h4>
      <input type="text" id="searchBox" placeholder="Search vendor..." class="form-control mb-3">

      <!-- ORDERS LIST -->
      <div style="max-height:500px; overflow-y:auto;">
        <table class="table table-bordered" id="ordersTable">
  <thead>
    <tr>
      <th>No</th>
      <th>Vendor</th>
      <th>Item</th>
      <th>Total Qty</th>
      <th>Unit</th>
      <th>Price</th>
      <th>Mess</th>
      <th>Canteen</th>
      <th>Date</th>
    </tr>
  </thead>

  <tbody>
    {% for o in orders %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ o.vendor_name }}</td>
      <td>{{ o.item_name }}</td>
      <td>{{ o.total_qty }}</td>
      <td>{{ o.unit }}</td>
      <td>{{ o.price }}</td>
      <td>{{ o.mess_qty }}</td>
      <td>{{ o.canteen_qty }}</td>
      <td>{{ o.order_date }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

      </div>
    </div>

  </div>

  <!-- JS -->
  <script>
    const inputs = document.querySelectorAll('input[type="number"]');
inputs.forEach(inp => {
  inp.addEventListener('input', () => {
    if (parseFloat(inp.value) < 0) {
      inp.value = "";
      alert("Value must be greater than 0");
    }
  });
});

    // items array from backend
const items = [
  {% for i in items %}
    { id: "{{ i.item_id }}", name: "{{ i.item_name }}", unit: "{{ i.unit }}" },
  {% endfor %}
];

const itemInput = document.getElementById("itemInput");
const itemID = document.getElementById("item_id");
const unitBox = document.getElementById("unitBox");
const suggestions = document.getElementById("suggestions");

let selectedIndex = -1;

// Render suggestion list
function renderSuggestions(list) {
  suggestions.innerHTML = "";
  selectedIndex = -1;

  list.forEach((item, index) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "list-group-item list-group-item-action";
    btn.textContent = item.name;

    btn.onclick = () => selectItem(item);

    suggestions.appendChild(btn);
  });

  suggestions.style.display = "block";
}

// Select item from list
function selectItem(item) {
  itemInput.value = item.name;
  itemID.value = item.id;
  unitBox.value = item.unit;
  suggestions.style.display = "none";
}

// On typing
itemInput.addEventListener("input", () => {
  const val = itemInput.value.toLowerCase().trim();

  if (val === "") {
    suggestions.style.display = "none";
    itemID.value = "";
    return;
  }

  const filtered = items.filter(i =>
    i.name.toLowerCase().includes(val)   // ðŸ”¥ contains search (not only startswith)
  );

  if (filtered.length === 0) {
    suggestions.style.display = "none";
    return;
  }

  renderSuggestions(filtered);
});

// Keyboard navigation support
itemInput.addEventListener("keydown", (e) => {
  const buttons = suggestions.querySelectorAll("button");
  if (suggestions.style.display === "none" || buttons.length === 0) return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    selectedIndex = (selectedIndex + 1) % buttons.length;
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    selectedIndex = (selectedIndex - 1 + buttons.length) % buttons.length;
  } else if (e.key === "Enter") {
    e.preventDefault();
    if (selectedIndex !== -1) buttons[selectedIndex].click();
    return;
  }

  buttons.forEach((btn, index) => {
    btn.style.background = index === selectedIndex ? "#007bff33" : "white";
  });
});

// Hide when clicking outside
document.addEventListener("click", (e) => {
  if (!itemInput.contains(e.target) && !suggestions.contains(e.target)) {
    suggestions.style.display = "none";
  }
});


    // SEARCH vendor
    const search = document.getElementById("searchBox");
    const rows = document.querySelectorAll("#ordersTable tbody tr");

    search.addEventListener("keyup", () => {
      let v = search.value.toLowerCase();
      rows.forEach(r => {
        let vendor = r.children[1].textContent.toLowerCase();
        r.style.display = vendor.includes(v) ? "" : "none";
      });
    });
  </script>

</body>
</html>
