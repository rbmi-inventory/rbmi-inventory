<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Received | RBMI Inventory System</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #cce5ff, #e8f4ff);
      font-family: "Poppins", sans-serif;
    }

    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #007bff, #00c6ff);
      color: white;
      padding-top: 20px;
      position: fixed;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0,0,0,0.15);
    }

    .sidebar .brand {
      text-align: center;
      margin-bottom: 25px;
    }

    .sidebar .brand img {
      height: 55px;
      border-radius: 8px;
      background: #fff;
      padding: 5px 8px;
    }

    .sidebar .nav-link {
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 5px 12px;
      transition: 0.2s;
    }

    .nav-link:hover,
    .nav-link.active {
      background: rgba(255,255,255,0.2);
      transform: translateX(4px);
    }

    .main-content {
      margin-left: 260px;
      padding: 20px;
    }

    .topbar {
      background: #ffffff;
      padding: 10px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .section-card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 3px 12px rgba(0,114,255,0.12);
      margin-bottom: 25px;
    }

    .table th {
      background: #007bff;
      color: white;
      text-align: center;
    }

    .table td {
      text-align: center;
    }

    .sidebar .brand h5 {
  font-size: 16px;
  background: rgba(255,255,255,0.15);
  padding: 5px 10px;
  border-radius: 8px;
  display: inline-block;
  color: white;
}
.table th {
  background: #007bff;
  color: white;
  text-align: center;
}



    /* Suggestions dropdown styling */
    #suggestions {
      position: absolute;
      width: 100%;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      max-height: 180px;
      overflow-y: auto;
      display: none;
      z-index: 2000;
    }
    #suggestions button {
      text-align: left;
    }
  </style>

  <style>
/* Vendor suggestion dropdown styling (same as item dropdown) */
#vendorSuggestions {
  position: absolute;
  width: 100%;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  max-height: 180px;
  overflow-y: auto;
  display: none;
  z-index: 2000;
}

#vendorSuggestions button {
  text-align: left;
  background: white;
  border: none;
  width: 100%;
}

#vendorSuggestions button:hover {
  background: #007bff33;
}
</style>


</head>
<body>

  <!-- Sidebar -->
<!-- Sidebar -->
<div class="sidebar">
  <div class="brand">
    <img src="{{ url_for('static', filename='images/rbmi_logo.png') }}">
    <h5>RBMI Inventory<br>Management System</h5>
  </div>

  <hr style="border-color: rgba(255,255,255,0.3)">

  <a class="nav-link" href="{{ url_for('add_item_master') }}">
    <i class="bi bi-speedometer2"></i> Add Item
  </a>

  <a class="nav-link active" href="{{ url_for('order_received') }}">
    <i class="bi bi-cart-check"></i> Purchase
  </a>
  <a class="nav-link" href="{{ url_for('manager_dashboard') }}">
    <i class="bi bi-box-seam"></i> Stock Dashboard
  </a>
  <a class="nav-link" href="{{ url_for('mess_dashboard') }}"><i class="bi bi-egg-fried"></i> Mess Dashboard</a>
  <a class="nav-link" href="{{ url_for('canteen_dashboard') }}"><i class="bi bi-shop"></i> Canteen Dashboard</a>
<a class="nav-link " href="{{ url_for('usage_report') }}"><i class="bi bi-file-earmark-text"></i> Usage Report</a>
<a class="nav-link" href="{{ url_for('transfer_stock') }}"><i class="bi bi-arrow-left-right"></i> Stock Transfer</a>
<a class="nav-link" href="{{ url_for('change_password') }}"><i class="bi bi-key"></i> Change Password</a>
<a class="nav-link text-danger" href="{{ url_for('logout') }}">
      <i class="bi bi-box-arrow-right"></i> Logout
    </a>
</div>



  <!-- Main -->
  <div class="main-content">

    <div class="topbar d-flex justify-content-between">
      <h5 class="fw-bold text-primary">Purchase</h5>
    </div>

    <!-- FLASH -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}

        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="section-card">

  <h4 class="text-primary fw-bold mb-3">Add New Purchase</h4>

  <form method="POST" id="purchaseForm">
    <table class="table table-bordered text-center align-middle">

      <tr>
        <th>Vendor</th>
        <th>Item</th>
        <th>Total Qty</th>
        <th>Unit</th>
        <th> Total Amount</th>
        <th>Mess Qty</th>
        <th>Canteen Qty</th>
        <th>Action</th>
      </tr>

      <tr>
        <td style="position:relative;">
    <input type="text" id="vendorInput" name="vendor_name" class="form-control" placeholder="Search vendor..." autocomplete="off" required>
    <div id="vendorSuggestions" class="list-group" 
         style="position:absolute; width:100%; z-index:2000; display:none;"></div>
</td>


        <td style="position:relative;">
            <input type="text" id="itemInput" class="form-control" placeholder="Search item..." autocomplete="off" required>
            <input type="hidden" name="item_id" id="item_id">
            <div id="suggestions" class="list-group"></div>
        </td>

        <td><input type="number" min="0" step="0.01" name="total_qty" class="form-control" required></td>

        <td><input type="text" name="unit" id="unitBox" class="form-control" readonly></td>

        <td><input type="number" min="0" step="0.01" name="price" class="form-control" required></td>

        <td><input type="number" min="0" step="0.01" name="mess_qty" class="form-control" required></td>

        <td><input type="number" min="0" step="0.01" name="canteen_qty" class="form-control" required></td>

        <td><button type="submit" class="btn btn-primary w-100" id="saveBtn">Save</button></td>
      </tr>

    </table>
</form>

<!-- ðŸ”’ Double-click lock script -->
<script>
document.getElementById("purchaseForm").addEventListener("submit", function () {
    const btn = document.getElementById("saveBtn");

    btn.disabled = true;
    btn.innerText = "Saving...";
});
</script>

</div>

    <!-- SEARCH -->
    <div class="section-card">
      <form method="GET" class="row g-3 mb-3">
  <div class="col-md-4">
    <label class="form-label fw-bold">From Date</label>
<input type="date" name="from_date"
       value="{{ request.args.get('from_date') or from_date }}"
       class="form-control">
        </div>

  <div class="col-md-4">
    <label class="form-label fw-bold">To Date</label>
<input type="date" name="to_date"
       value="{{ request.args.get('to_date') or to_date }}"
       class="form-control">
  </div>

  <div class="col-md-2">
  <label class="form-label fw-bold">Action</label><br>
  <button class="btn btn-primary w-100">Filter</button>
</div>

<div class="col-md-2">
  <label class="form-label fw-bold">Export</label><br>

  <a class="btn btn-success w-100"
     href="{{ url_for('export_orders_csv',
                      from_date=request.args.get('from_date') or from_date,
                      to_date=request.args.get('to_date') or to_date) }}">
    CSV
  </a>
</div>

</form>

      <h4 class="text-primary fw-bold mb-3">Purchased History</h4>
      <input type="text" id="searchBox" placeholder="Search vendor..." class="form-control mb-3">

      <!-- ORDERS LIST -->
      <div style="max-height:500px; overflow-y:auto;">
        <table class="table table-bordered" id="ordersTable">
  <thead>
    <tr>
      <th>No</th>
      <th>Vendor</th>
      <th>Item</th>
      <th>Total Qty</th>
      <th> Total Amount</th>
      <th>Mess</th>
      <th>Canteen</th>
      <th>Date</th>
    </tr>
  </thead>

  <tbody>
    {% for o in orders %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ o.vendor_name }}</td>
      <td>{{ o.item_name }}</td>
      <td>{{ o.total_qty }}&nbsp;&nbsp;&nbsp;{{ o.unit }}</td>
      <td>{{ o.price }}</td>
      <td>{{ o.mess_qty }}&nbsp;&nbsp;&nbsp;{{ o.unit }}</td>
      <td>{{ o.canteen_qty }}&nbsp;&nbsp;&nbsp;{{ o.unit }}</td>
      <td>{{ o.order_date.strftime('%d-%m-%Y') }}</td>

    </tr>
    {% endfor %}
  </tbody>
</table>

      </div>
    </div>

  </div>

  <!-- JS -->
  <script>
    const inputs = document.querySelectorAll('input[type="number"]');
inputs.forEach(inp => {
  inp.addEventListener('input', () => {
    if (parseFloat(inp.value) < 0) {
      inp.value = "";
      alert("Value must be greater than 0");
    }
  });
});

    // items array from backend
const items = [
  {% for i in items %}
    { id: "{{ i.item_id }}", name: "{{ i.item_name }}", unit: "{{ i.unit }}" },
  {% endfor %}
];

// vendor list from backend
const vendors = [
  {% for v in vendors %}
    "{{ v }}",
  {% endfor %}
];


const itemInput = document.getElementById("itemInput");
const itemID = document.getElementById("item_id");
const unitBox = document.getElementById("unitBox");
const suggestions = document.getElementById("suggestions");

let selectedIndex = -1;

// Render suggestion list
function renderSuggestions(list) {
  suggestions.innerHTML = "";
  selectedIndex = -1;

  list.forEach((item, index) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "list-group-item list-group-item-action";
    btn.textContent = item.name;

    btn.onclick = () => selectItem(item);

    suggestions.appendChild(btn);
  });

  suggestions.style.display = "block";
}

// Select item from list
function selectItem(item) {
  itemInput.value = item.name;
  itemID.value = item.id;
  unitBox.value = item.unit;
  suggestions.style.display = "none";
}

// On typing
// On typing (auto-select first suggestion)
itemInput.addEventListener("input", () => {
  const val = itemInput.value.toLowerCase().trim();

  if (val === "") {
    suggestions.style.display = "none";
    itemID.value = "";
    return;
  }

  const filtered = items.filter(i =>
    i.name.toLowerCase().includes(val)
  );

  if (filtered.length === 0) {
    suggestions.style.display = "none";
    return;
  }

  renderSuggestions(filtered);

  // ðŸ”¥ Auto-select first suggestion
  selectedIndex = 0;
  const buttons = suggestions.querySelectorAll("button");
  if (buttons.length > 0) {
    buttons[0].style.background = "#007bff33";
  }
});

// Keyboard navigation support + auto-select on enter
itemInput.addEventListener("keydown", (e) => {
  const buttons = suggestions.querySelectorAll("button");
  if (suggestions.style.display === "none" || buttons.length === 0) return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    selectedIndex = (selectedIndex + 1) % buttons.length;
  } 
  else if (e.key === "ArrowUp") {
    e.preventDefault();
    selectedIndex = (selectedIndex - 1 + buttons.length) % buttons.length;
  } 
  else if (e.key === "Enter") {
    e.preventDefault();
    buttons[selectedIndex].click();    // ðŸ”¥ Enter â†’ select
    return;
  }

  buttons.forEach((btn, index) => {
    btn.style.background = index === selectedIndex ? "#007bff33" : "white";
  });
});

// Hide when clicking outside
document.addEventListener("click", (e) => {
  if (!itemInput.contains(e.target) && !suggestions.contains(e.target)) {
    suggestions.style.display = "none";
  }
});


    // SEARCH vendor
    const search = document.getElementById("searchBox");
    const rows = document.querySelectorAll("#ordersTable tbody tr");

    search.addEventListener("keyup", () => {
      let v = search.value.toLowerCase();
      rows.forEach(r => {
        let vendor = r.children[1].textContent.toLowerCase();
        r.style.display = vendor.includes(v) ? "" : "none";
      });
    });

    // AUTO CALC for Mess & Canteen
const totalQty = document.querySelector('input[name="total_qty"]');
const messQty = document.querySelector('input[name="mess_qty"]');
const canteenQty = document.querySelector('input[name="canteen_qty"]');

function updateFromMess() {
  let total = parseFloat(totalQty.value) || 0;
  let mess = parseFloat(messQty.value) || 0;

  if (mess > total) {
    messQty.value = "";
    canteenQty.value = "";
    alert("Mess qty cannot exceed total qty");
    return;
  }

  canteenQty.value = (total - mess).toFixed(2);
}

function updateFromCanteen() {
  let total = parseFloat(totalQty.value) || 0;
  let canteen = parseFloat(canteenQty.value) || 0;

  if (canteen > total) {
    canteenQty.value = "";
    messQty.value = "";
    alert("Canteen qty cannot exceed total qty");
    return;
  }

  messQty.value = (total - canteen).toFixed(2);
}

// Events
messQty.addEventListener("input", updateFromMess);
canteenQty.addEventListener("input", updateFromCanteen);
totalQty.addEventListener("input", () => {
  messQty.value = "";
  canteenQty.value = "";
});
// ------------------ Vendor Auto Suggest ------------------
const vendorInput = document.getElementById("vendorInput");
const vendorSuggestions = document.getElementById("vendorSuggestions");

let vendorIndex = -1;

function showVendorSuggestions(list) {
    vendorSuggestions.innerHTML = "";
    vendorIndex = -1;

    list.forEach((name, index) => {
        let btn = document.createElement("button");
        btn.type = "button";
        btn.className = "list-group-item list-group-item-action";
        btn.textContent = name;

        btn.onclick = () => {
            vendorInput.value = name;
            vendorSuggestions.style.display = "none";
        };

        vendorSuggestions.appendChild(btn);
    });

    vendorSuggestions.style.display = "block";
}

vendorInput.addEventListener("input", () => {
    let text = vendorInput.value.toLowerCase();

    if (!text) {
        vendorSuggestions.style.display = "none";
        return;
    }

    let match = vendors.filter(v => v.toLowerCase().includes(text));

    if (match.length === 0) {
        vendorSuggestions.style.display = "none";
        return;
    }

    showVendorSuggestions(match);

    vendorIndex = 0;
    vendorSuggestions.children[0].style.background = "#007bff33";
});

vendorInput.addEventListener("keydown", (e) => {
    const btns = vendorSuggestions.children;

    if (btns.length === 0) return;

    if (e.key === "ArrowDown") {
        e.preventDefault();
        vendorIndex = (vendorIndex + 1) % btns.length;
    } else if (e.key === "ArrowUp") {
        e.preventDefault();
        vendorIndex = (vendorIndex - 1 + btns.length) % btns.length;
    } else if (e.key === "Enter") {
        e.preventDefault();
        btns[vendorIndex].click();
        return;
    }

    Array.from(btns).forEach((btn, i) => {
        btn.style.background = i === vendorIndex ? "#007bff33" : "white";
    });
});

document.addEventListener("click", (e) => {
    if (!vendorInput.contains(e.target) && !vendorSuggestions.contains(e.target)) {
        vendorSuggestions.style.display = "none";
    }
});


  </script>

</body>
</html>
